name: CI/CD Pipeline
permissions:
  contents: write

# Trigger on push to main branch and on pull requests
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

# Environment variables shared across jobs
env:
  PYTHON_VERSION: '3.11'
  AZURE_FUNCTIONAPP_PACKAGE_PATH: './src'
  RESOURCE_GROUP_DEV: 'rg-invoice-agent-dev'
  RESOURCE_GROUP_PROD: 'rg-invoice-agent-prod'
  STORAGE_ACCOUNT_PROD: 'stinvoiceagentprod'
  FUNCTION_APP_PROD: 'func-invoice-agent-prod'

jobs:
  # Job 1: Run tests, linting, and code quality checks
  test:
    name: Test and Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for gitleaks commit range scanning

      - name: Scan for secrets with Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Only needed for enterprise

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'src/requirements.txt'

      - name: Install dependencies
        working-directory: ./src
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black flake8 coverage

      - name: Start Azurite (Azure Storage Emulator)
        run: |
          echo "Starting Azurite for integration tests..."
          docker run -d -p 10000:10000 -p 10001:10001 -p 10002:10002 \
            --name azurite \
            mcr.microsoft.com/azure-storage/azurite
          echo "Waiting for Azurite to be ready..."
          sleep 5

      - name: Check code formatting with Black
        working-directory: ./src
        run: |
          echo "Running Black formatter check..."
          black --check --diff MailIngest/ ExtractEnrich/ PostToAP/ Notify/ AddVendor/ shared/

      - name: Lint with Flake8
        working-directory: ./src
        run: |
          echo "Running Flake8 linter..."
          # Stop the build if there are Python syntax errors or undefined names
          flake8 MailIngest/ ExtractEnrich/ PostToAP/ Notify/ AddVendor/ shared/ --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings (line length=127 to match Black default)
          flake8 MailIngest/ ExtractEnrich/ PostToAP/ Notify/ AddVendor/ shared/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run unit tests with coverage
        working-directory: .
        run: |
          echo "Running tests under coverage..."
          python -m pip install coverage
          # Run tests and create .coverage (exclude integration tests)
          coverage run -m pytest -m "not integration" || TEST_EXIT=$?
          # Propagate pytest non-zero exit after collecting coverage so subsequent coverage report can run
          if [ -n "${TEST_EXIT}" ]; then exit ${TEST_EXIT}; fi

      - name: Generate coverage report
        if: always()
        working-directory: .
        run: |
          echo "Generating coverage report..."
          if [ -f .coverage ]; then
            coverage report
            coverage html
          else
            echo "No coverage data (.coverage file missing) â€” ensure tests are run with coverage"
            exit 0
          fi

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: pytest.xml
          retention-days: 30

  # Job 2: Build and package Azure Functions
  build:
    name: Build Azure Functions Package
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'src/requirements.txt'

      - name: Install Azure Functions Core Tools
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
          sudo mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg
          sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-ubuntu-$(lsb_release -cs)-prod $(lsb_release -cs) main" > /etc/apt/sources.list.d/dotnetdev.list'
          sudo apt-get update
          sudo apt-get install azure-functions-core-tools-4

      - name: Install Python dependencies
        working-directory: ./src
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt --target ".python_packages/lib/site-packages"

      - name: Create deployment package
        working-directory: ./src
        run: |
          # Remove test and development dependencies from package
          rm -rf .python_packages/lib/site-packages/pytest*
          rm -rf .python_packages/lib/site-packages/_pytest*
          rm -rf .python_packages/lib/site-packages/coverage*
          rm -rf .python_packages/lib/site-packages/mypy*
          rm -rf .python_packages/lib/site-packages/bandit*

          # Create archive for deployment
          zip -r ../function-app.zip .

      - name: Validate deployment package
        working-directory: ./src
        run: |
          # Check Python version
          python --version

          # Test imports with the exact PYTHONPATH that Azure Functions uses
          export PYTHONPATH=.:.python_packages/lib/site-packages
          python -c "
          import sys
          print(f'Python {sys.version}')
          print(f'PYTHONPATH: {sys.path[:3]}')

          # Test critical imports
          try:
              import azure.functions
              print('azure.functions imported')
          except ImportError as e:
              print(f'Failed to import azure.functions: {e}')
              sys.exit(1)

          try:
              import shared.models
              print('shared.models imported')
          except ImportError as e:
              print(f'Failed to import shared.models: {e}')
              sys.exit(1)

          try:
              from MailIngest import main
              print('MailIngest function imported')
          except ImportError as e:
              print(f'Failed to import MailIngest: {e}')
              sys.exit(1)

          print('All critical imports successful')
          "

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: function-app-package
          # IMPORTANT: Upload ZIP directly (not in subdirectory)
          # download-artifact@v4 creates a directory named 'function-app-package/' automatically
          # Pattern: If we upload 'dir/file.zip', download extracts to 'function-app-package/dir/file.zip' (WRONG)
          # Pattern: If we upload 'file.zip', download extracts to 'function-app-package/file.zip' (CORRECT)
          path: function-app.zip
          retention-days: 30

  # Job 3: Deploy to production (direct blob URL deployment)
  # This replaces the previous staging + slot swap approach which had reliability issues
  # on Linux Consumption plan with WEBSITE_RUN_FROM_PACKAGE=1
  deploy-production:
    name: Deploy to Production
    needs: build
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
    environment:
      name: production
      url: https://func-invoice-agent-prod.azurewebsites.net

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: function-app-package
          path: .

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: Lint Bicep templates
        run: |
          echo "Linting Bicep templates..."
          az bicep lint --file infrastructure/bicep/main.bicep
          az bicep lint --file infrastructure/bicep/modules/storage.bicep
          az bicep lint --file infrastructure/bicep/modules/functionapp.bicep
          az bicep lint --file infrastructure/bicep/modules/keyvault.bicep
          az bicep lint --file infrastructure/bicep/modules/monitoring.bicep
          az bicep lint --file infrastructure/bicep/modules/rbac.bicep
          echo "Bicep linting completed successfully"

      - name: Deploy infrastructure (if needed)
        run: |
          echo "Checking infrastructure deployment..."
          az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP_PROD }} \
            --template-file infrastructure/bicep/main.bicep \
            --parameters infrastructure/parameters/prod.json \
            --mode Incremental \
            --verbose

      - name: Upload package to blob storage
        id: upload
        run: |
          PACKAGE_NAME="function-app-${{ github.sha }}.zip"
          echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
          echo "Uploading ${PACKAGE_NAME} to blob storage..."

          az storage blob upload \
            --container-name function-releases \
            --name "${PACKAGE_NAME}" \
            --file function-app.zip \
            --account-name ${{ env.STORAGE_ACCOUNT_PROD }} \
            --auth-mode login \
            --overwrite

          echo "Package uploaded successfully"

      - name: Generate SAS URL (1 year expiry)
        id: sas
        run: |
          # Calculate expiry date (1 year from now)
          EXPIRY=$(date -u -d "+1 year" +%Y-%m-%dT%H:%MZ)
          echo "SAS expiry: ${EXPIRY}"

          SAS_URL=$(az storage blob generate-sas \
            --container-name function-releases \
            --name "${{ steps.upload.outputs.package_name }}" \
            --permissions r \
            --expiry "${EXPIRY}" \
            --account-name ${{ env.STORAGE_ACCOUNT_PROD }} \
            --auth-mode login \
            --as-user \
            --full-uri \
            -o tsv)

          # Mask the SAS URL in logs (contains sensitive signature)
          echo "::add-mask::${SAS_URL}"
          echo "url=${SAS_URL}" >> $GITHUB_OUTPUT
          echo "SAS URL generated successfully"

      - name: Deploy to production
        run: |
          echo "Updating WEBSITE_RUN_FROM_PACKAGE setting..."
          az functionapp config appsettings set \
            --name ${{ env.FUNCTION_APP_PROD }} \
            --resource-group ${{ env.RESOURCE_GROUP_PROD }} \
            --settings "WEBSITE_RUN_FROM_PACKAGE=${{ steps.sas.outputs.url }}" \
            --output none

          echo "App setting updated successfully"

      - name: Restart and wait for production
        run: |
          echo "Restarting function app..."
          az functionapp restart \
            --name ${{ env.FUNCTION_APP_PROD }} \
            --resource-group ${{ env.RESOURCE_GROUP_PROD }}

          echo "Waiting 45 seconds for production to stabilize..."
          sleep 45

      - name: Verify production health
        run: |
          PROD_URL="https://${{ env.FUNCTION_APP_PROD }}.azurewebsites.net"

          echo "Checking production health endpoint..."

          # Get the function key for health check
          FUNC_KEY=$(az functionapp keys list \
            --name ${{ env.FUNCTION_APP_PROD }} \
            --resource-group ${{ env.RESOURCE_GROUP_PROD }} \
            --query "functionKeys.default" -o tsv)

          HTTP_STATUS=$(curl -s -o /tmp/health_response.json -w "%{http_code}" \
            "${PROD_URL}/api/health?code=${FUNC_KEY}" \
            --max-time 60 || echo "000")

          echo "Health check response: ${HTTP_STATUS}"

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "PASS: Production health check succeeded"
            cat /tmp/health_response.json
          else
            echo "ERROR: Health check failed with status $HTTP_STATUS"
            cat /tmp/health_response.json 2>/dev/null || true
            exit 1
          fi

      - name: Verify functions loaded
        run: |
          echo "Verifying functions are loaded..."
          FUNC_COUNT=$(az functionapp function list \
            --name ${{ env.FUNCTION_APP_PROD }} \
            --resource-group ${{ env.RESOURCE_GROUP_PROD }} \
            --query "length(@)" -o tsv)

          echo "Functions loaded: ${FUNC_COUNT}"

          if [ "${FUNC_COUNT}" -ge 9 ]; then
            echo "PASS: All expected functions loaded"
          else
            echo "ERROR: Expected 9 functions, found ${FUNC_COUNT}"
            exit 1
          fi

      - name: Tag release
        run: |
          TAG_NAME="prod-$(date +%Y%m%d-%H%M%S)"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "$TAG_NAME" -m "Production release $(date) - ${{ github.sha }}"
          git push origin "$TAG_NAME" || echo "Tag push failed (may need repo permissions)"
          echo "Created release tag: $TAG_NAME"

      - name: Azure Logout
        if: always()
        run: az logout

  # Job 4: Deployment Validation Gate (ensures all checks pass on main)
  validate-deployment:
    name: Validate All Checks
    needs: [test, build, deploy-production]
    runs-on: ubuntu-latest
    # Only run on main branch pushes (deployment validation)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Report deployment status
        run: |
          echo "All checks passed:"
          echo "  Tests passed"
          echo "  Build succeeded"
          echo "  Production deployment successful"
          echo ""
          echo "Deployment validation complete. Code is safe in main."

  # Job 5: Deploy to dev environment (for testing infrastructure changes)
  deploy-dev:
    name: Deploy to Dev Environment
    needs: [test, build]
    runs-on: ubuntu-latest
    # Only run on workflow_dispatch or when infrastructure files change
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[deploy-dev]')
    environment:
      name: development
      url: https://func-invoice-agent-dev.azurewebsites.net
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: function-app-package
          path: .
        continue-on-error: true

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_DEV }}

      - name: Lint Bicep templates
        run: |
          echo "Linting Bicep templates..."
          az bicep lint --file infrastructure/bicep/main.bicep
          az bicep lint --file infrastructure/bicep/modules/storage.bicep
          az bicep lint --file infrastructure/bicep/modules/functionapp.bicep
          az bicep lint --file infrastructure/bicep/modules/keyvault.bicep
          az bicep lint --file infrastructure/bicep/modules/monitoring.bicep
          az bicep lint --file infrastructure/bicep/modules/rbac.bicep
          echo "Bicep linting completed successfully"

      - name: Deploy dev infrastructure
        run: |
          echo "Deploying dev infrastructure..."
          az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP_DEV }} \
            --template-file infrastructure/bicep/main.bicep \
            --parameters infrastructure/parameters/dev.json \
            --mode Incremental \
            --verbose

      - name: Get Function App name
        id: func-name
        run: |
          FUNC_NAME=$(az functionapp list \
            --resource-group ${{ env.RESOURCE_GROUP_DEV }} \
            --query "[?contains(name, 'invoice-agent')].name" -o tsv)
          echo "function_app_name=${FUNC_NAME}" >> $GITHUB_OUTPUT
          echo "Function App: ${FUNC_NAME}"

      - name: Deploy functions to dev
        if: hashFiles('function-app.zip') != ''
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ steps.func-name.outputs.function_app_name }}
          package: function-app.zip

      - name: Azure Logout
        if: always()
        run: az logout
