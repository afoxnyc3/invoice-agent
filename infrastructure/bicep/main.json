{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "7476821320879861896"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "Environment name"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for resources"
      }
    },
    "projectPrefix": {
      "type": "string",
      "defaultValue": "invoice-agent",
      "metadata": {
        "description": "Project name prefix"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "Project": "InvoiceAgent",
        "Environment": "[parameters('environment')]",
        "Owner": "AlexFox",
        "ManagedBy": "Bicep",
        "CostCenter": "Finance-AP",
        "Application": "invoice-agent",
        "CreatedDate": "2024-11-14"
      },
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    }
  },
  "variables": {
    "namingPrefix": "[format('{0}-{1}', parameters('projectPrefix'), parameters('environment'))]",
    "storageAccountName": "[replace(format('st{0}{1}', parameters('projectPrefix'), parameters('environment')), '-', '')]",
    "functionAppName": "[format('func-{0}', variables('namingPrefix'))]",
    "appServicePlanName": "[format('asp-{0}', variables('namingPrefix'))]",
    "keyVaultName": "[format('kv-{0}', take(variables('namingPrefix'), 20))]",
    "appInsightsName": "[format('ai-{0}', variables('namingPrefix'))]",
    "workspaceName": "[format('log-{0}', variables('namingPrefix'))]"
  },
  "resources": {
    "storage": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "storage-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "storageAccountName": {
            "value": "[variables('storageAccountName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "13977811880289521806"
            }
          },
          "parameters": {
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "environment": {
              "type": "string",
              "allowedValues": [
                "dev",
                "staging",
                "prod"
              ],
              "metadata": {
                "description": "Environment"
              }
            }
          },
          "variables": {
            "queueNames": [
              "raw-mail",
              "raw-mail-poison",
              "to-post",
              "to-post-poison",
              "notify",
              "notify-poison"
            ],
            "tableNames": [
              "VendorMaster",
              "InvoiceTransactions"
            ]
          },
          "resources": {
            "storageAccount": {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[parameters('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[if(equals(parameters('environment'), 'prod'), 'Standard_GRS', 'Standard_LRS')]"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "supportsHttpsTrafficOnly": true,
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": false,
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            },
            "blobService": {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": []
                },
                "deleteRetentionPolicy": {
                  "enabled": true,
                  "days": "[if(equals(parameters('environment'), 'prod'), 30, 7)]"
                },
                "containerDeleteRetentionPolicy": {
                  "enabled": true,
                  "days": "[if(equals(parameters('environment'), 'prod'), 30, 7)]"
                }
              },
              "dependsOn": [
                "storageAccount"
              ]
            },
            "invoiceContainer": {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', 'invoices')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "blobService"
              ]
            },
            "queueService": {
              "type": "Microsoft.Storage/storageAccounts/queueServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": []
                }
              },
              "dependsOn": [
                "storageAccount"
              ]
            },
            "queues": {
              "copy": {
                "name": "queues",
                "count": "[length(variables('queueNames'))]"
              },
              "type": "Microsoft.Storage/storageAccounts/queueServices/queues",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', variables('queueNames')[copyIndex()])]",
              "properties": {},
              "dependsOn": [
                "queueService"
              ]
            },
            "tableService": {
              "type": "Microsoft.Storage/storageAccounts/tableServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": []
                }
              },
              "dependsOn": [
                "storageAccount"
              ]
            },
            "tables": {
              "copy": {
                "name": "tables",
                "count": "[length(variables('tableNames'))]"
              },
              "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', variables('tableNames')[copyIndex()])]",
              "properties": {},
              "dependsOn": [
                "tableService"
              ]
            }
          },
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "value": "[parameters('storageAccountName')]"
            },
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
            },
            "connectionString": {
              "type": "securestring",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', parameters('storageAccountName'), environment().suffixes.storage, listKeys('storageAccount', '2023-01-01').keys[0].value)]"
            },
            "blobEndpoint": {
              "type": "string",
              "value": "[reference('storageAccount').primaryEndpoints.blob]"
            },
            "queueEndpoint": {
              "type": "string",
              "value": "[reference('storageAccount').primaryEndpoints.queue]"
            },
            "tableEndpoint": {
              "type": "string",
              "value": "[reference('storageAccount').primaryEndpoints.table]"
            }
          }
        }
      }
    },
    "monitoring": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "monitoring-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appInsightsName": {
            "value": "[variables('appInsightsName')]"
          },
          "workspaceName": {
            "value": "[variables('workspaceName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "11327481043497787486"
            }
          },
          "parameters": {
            "appInsightsName": {
              "type": "string",
              "metadata": {
                "description": "Application Insights name"
              }
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('workspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 90,
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "workspaceCapping": {
                  "dailyQuotaGb": 1
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            },
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('appInsightsName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]",
                "IngestionMode": "LogAnalytics",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled",
                "RetentionInDays": 90,
                "SamplingPercentage": 100,
                "DisableLocalAuth": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/components/ProactiveDetectionConfigs",
              "apiVersion": "2018-05-01-preview",
              "name": "[format('{0}/{1}', parameters('appInsightsName'), 'degradationindependencyduration')]",
              "properties": {
                "ruleDefinitions": {
                  "Name": "degradationindependencyduration",
                  "DisplayName": "Degradation in dependency duration",
                  "Description": "Smart Detection rules notify you of performance anomaly issues.",
                  "HelpUrl": "https://docs.microsoft.com/en-us/azure/application-insights/app-insights-proactive-performance-diagnostics",
                  "IsHidden": false,
                  "IsEnabledByDefault": true,
                  "IsInPreview": false,
                  "SupportsEmailNotifications": true
                },
                "enabled": false,
                "customEmails": []
              },
              "dependsOn": [
                "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
              ]
            }
          ],
          "outputs": {
            "appInsightsName": {
              "type": "string",
              "value": "[parameters('appInsightsName')]"
            },
            "appInsightsId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
            },
            "instrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').InstrumentationKey]"
            },
            "connectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').ConnectionString]"
            },
            "workspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
            }
          }
        }
      }
    },
    "functionApp": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "functionapp-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppName": {
            "value": "[variables('functionAppName')]"
          },
          "appServicePlanName": {
            "value": "[variables('appServicePlanName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "storageAccountName": {
            "value": "[reference('storage').outputs.storageAccountName.value]"
          },
          "storageAccountConnectionString": {
            "value": "[listOutputsWithSecureValues('storage', '2025-04-01').connectionString]"
          },
          "appInsightsInstrumentationKey": {
            "value": "[reference('monitoring').outputs.instrumentationKey.value]"
          },
          "keyVaultName": {
            "value": "[variables('keyVaultName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "9960021810558966944"
            }
          },
          "parameters": {
            "functionAppName": {
              "type": "string",
              "metadata": {
                "description": "Function App name"
              }
            },
            "appServicePlanName": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              }
            },
            "storageAccountConnectionString": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Storage account connection string (deprecated - kept for backward compatibility)"
              }
            },
            "appInsightsInstrumentationKey": {
              "type": "securestring",
              "metadata": {
                "description": "Application Insights instrumentation key"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[parameters('appServicePlanName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Y1",
                "tier": "Dynamic"
              },
              "properties": {
                "reserved": true
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[parameters('functionAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
                "reserved": true,
                "siteConfig": {
                  "pythonVersion": "3.11",
                  "linuxFxVersion": "PYTHON|3.11",
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage__accountName",
                      "value": "[parameters('storageAccountName')]"
                    },
                    {
                      "name": "AzureWebJobsStorage__blobServiceUri",
                      "value": "[format('https://{0}.blob.core.windows.net', parameters('storageAccountName'))]"
                    },
                    {
                      "name": "AzureWebJobsStorage__queueServiceUri",
                      "value": "[format('https://{0}.queue.core.windows.net', parameters('storageAccountName'))]"
                    },
                    {
                      "name": "AzureWebJobsStorage__tableServiceUri",
                      "value": "[format('https://{0}.table.core.windows.net', parameters('storageAccountName'))]"
                    },
                    {
                      "name": "AzureWebJobsStorage__credential",
                      "value": "managedidentity"
                    },
                    {
                      "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
                      "value": "[parameters('storageAccountConnectionString')]"
                    },
                    {
                      "name": "WEBSITE_CONTENTSHARE",
                      "value": "[toLower(parameters('functionAppName'))]"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "python"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[parameters('appInsightsInstrumentationKey')]"
                    },
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[format('InstrumentationKey={0}', parameters('appInsightsInstrumentationKey'))]"
                    },
                    {
                      "name": "KEY_VAULT_URL",
                      "value": "[format('https://{0}.vault.azure.net/', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "GRAPH_TENANT_ID",
                      "value": "[format('@Microsoft.KeyVault(SecretUri=https://{0}.vault.azure.net/secrets/graph-tenant-id/)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "GRAPH_CLIENT_ID",
                      "value": "[format('@Microsoft.KeyVault(SecretUri=https://{0}.vault.azure.net/secrets/graph-client-id/)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "GRAPH_CLIENT_SECRET",
                      "value": "[format('@Microsoft.KeyVault(SecretUri=https://{0}.vault.azure.net/secrets/graph-client-secret/)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "INVOICE_MAILBOX",
                      "value": "[format('@Microsoft.KeyVault(SecretUri=https://{0}.vault.azure.net/secrets/invoice-mailbox/)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "AP_EMAIL_ADDRESS",
                      "value": "[format('@Microsoft.KeyVault(SecretUri=https://{0}.vault.azure.net/secrets/ap-email-address/)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "TEAMS_WEBHOOK_URL",
                      "value": "[format('@Microsoft.KeyVault(SecretUri=https://{0}.vault.azure.net/secrets/teams-webhook-url/)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "AZURE_OPENAI_ENDPOINT",
                      "value": "[format('@Microsoft.KeyVault(SecretUri=https://{0}.vault.azure.net/secrets/azure-openai-endpoint/)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "AZURE_OPENAI_API_KEY",
                      "value": "[format('@Microsoft.KeyVault(SecretUri=https://{0}.vault.azure.net/secrets/azure-openai-api-key/)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "WEBSITE_RUN_FROM_PACKAGE",
                      "value": "1"
                    },
                    {
                      "name": "PYDANTIC_PURE_PYTHON",
                      "value": "1"
                    }
                  ],
                  "cors": {
                    "allowedOrigins": []
                  },
                  "ftpsState": "Disabled",
                  "minTlsVersion": "1.2",
                  "scmMinTlsVersion": "1.2",
                  "http20Enabled": true,
                  "autoHealEnabled": true,
                  "autoHealRules": {
                    "triggers": {
                      "statusCodes": [
                        {
                          "status": 500,
                          "subStatus": 0,
                          "win32Status": 0,
                          "count": 10,
                          "timeInterval": "00:05:00"
                        }
                      ],
                      "slowRequests": {
                        "timeTaken": "00:01:00",
                        "count": 5,
                        "timeInterval": "00:05:00"
                      }
                    },
                    "actions": {
                      "actionType": "Recycle",
                      "minProcessExecutionTime": "00:01:00"
                    }
                  }
                },
                "httpsOnly": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites/slots",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', parameters('functionAppName'), 'staging')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "functionapp,linux",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
                "reserved": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
                "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
              ]
            }
          ],
          "outputs": {
            "functionAppName": {
              "type": "string",
              "value": "[parameters('functionAppName')]"
            },
            "functionAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
            },
            "functionAppUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01').defaultHostName)]"
            },
            "functionAppPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionAppName')), '2023-01-01', 'full').identity.principalId]"
            },
            "stagingSlotPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites/slots', parameters('functionAppName'), 'staging'), '2023-01-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "monitoring",
        "storage"
      ]
    },
    "keyVault": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "keyvault-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[variables('keyVaultName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "functionAppPrincipalId": {
            "value": "[reference('functionApp').outputs.functionAppPrincipalId.value]"
          },
          "stagingSlotPrincipalId": {
            "value": "[reference('functionApp').outputs.stagingSlotPrincipalId.value]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference('monitoring').outputs.workspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "16793350317209840611"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Resource tags"
              }
            },
            "functionAppPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Function App principal ID (Managed Identity)"
              }
            },
            "stagingSlotPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Staging slot principal ID (Managed Identity)"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Log Analytics Workspace ID for diagnostic settings"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[subscription().tenantId]",
                "enabledForDeployment": false,
                "enabledForTemplateDeployment": true,
                "enabledForDiskEncryption": false,
                "enableRbacAuthorization": false,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 90,
                "enablePurgeProtection": true,
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                },
                "accessPolicies": [
                  {
                    "tenantId": "[subscription().tenantId]",
                    "objectId": "[parameters('functionAppPrincipalId')]",
                    "permissions": {
                      "secrets": [
                        "get",
                        "list"
                      ]
                    }
                  },
                  {
                    "tenantId": "[subscription().tenantId]",
                    "objectId": "[parameters('stagingSlotPrincipalId')]",
                    "permissions": {
                      "secrets": [
                        "get",
                        "list"
                      ]
                    }
                  }
                ]
              }
            },
            {
              "condition": "[not(empty(parameters('logAnalyticsWorkspaceId')))]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[format('{0}-diagnostics', parameters('keyVaultName'))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "category": "AuditEvent",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            }
          ],
          "outputs": {
            "keyVaultName": {
              "type": "string",
              "value": "[parameters('keyVaultName')]"
            },
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
            },
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri]"
            }
          }
        }
      },
      "dependsOn": [
        "functionApp",
        "monitoring"
      ]
    },
    "rbac": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "rbac-deployment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "functionAppPrincipalId": {
            "value": "[reference('functionApp').outputs.functionAppPrincipalId.value]"
          },
          "stagingSlotPrincipalId": {
            "value": "[reference('functionApp').outputs.stagingSlotPrincipalId.value]"
          },
          "storageAccountId": {
            "value": "[reference('storage').outputs.storageAccountId.value]"
          },
          "keyVaultId": {
            "value": "[reference('keyVault').outputs.keyVaultId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "14904886965212555226"
            }
          },
          "parameters": {
            "functionAppPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Function App principal ID (Managed Identity)"
              }
            },
            "stagingSlotPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Staging slot principal ID (Managed Identity)"
              }
            },
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "Storage Account resource ID"
              }
            },
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault resource ID"
              }
            }
          },
          "variables": {
            "roles": {
              "storageBlobDataContributor": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
              "storageQueueDataContributor": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
              "storageTableDataContributor": "0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3",
              "keyVaultSecretsUser": "4633458b-17de-408a-b874-0445c86b69e6"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', split(parameters('storageAccountId'), '/')[8])]",
              "name": "[guid(parameters('storageAccountId'), parameters('functionAppPrincipalId'), variables('roles').storageBlobDataContributor)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataContributor)]",
                "principalId": "[parameters('functionAppPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', split(parameters('storageAccountId'), '/')[8])]",
              "name": "[guid(parameters('storageAccountId'), parameters('functionAppPrincipalId'), variables('roles').storageQueueDataContributor)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageQueueDataContributor)]",
                "principalId": "[parameters('functionAppPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', split(parameters('storageAccountId'), '/')[8])]",
              "name": "[guid(parameters('storageAccountId'), parameters('functionAppPrincipalId'), variables('roles').storageTableDataContributor)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageTableDataContributor)]",
                "principalId": "[parameters('functionAppPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', split(parameters('keyVaultId'), '/')[8])]",
              "name": "[guid(parameters('keyVaultId'), parameters('functionAppPrincipalId'), variables('roles').keyVaultSecretsUser)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').keyVaultSecretsUser)]",
                "principalId": "[parameters('functionAppPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', split(parameters('storageAccountId'), '/')[8])]",
              "name": "[guid(parameters('storageAccountId'), parameters('stagingSlotPrincipalId'), variables('roles').storageBlobDataContributor)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataContributor)]",
                "principalId": "[parameters('stagingSlotPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', split(parameters('storageAccountId'), '/')[8])]",
              "name": "[guid(parameters('storageAccountId'), parameters('stagingSlotPrincipalId'), variables('roles').storageQueueDataContributor)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageQueueDataContributor)]",
                "principalId": "[parameters('stagingSlotPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', split(parameters('storageAccountId'), '/')[8])]",
              "name": "[guid(parameters('storageAccountId'), parameters('stagingSlotPrincipalId'), variables('roles').storageTableDataContributor)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageTableDataContributor)]",
                "principalId": "[parameters('stagingSlotPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', split(parameters('keyVaultId'), '/')[8])]",
              "name": "[guid(parameters('keyVaultId'), parameters('stagingSlotPrincipalId'), variables('roles').keyVaultSecretsUser)]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').keyVaultSecretsUser)]",
                "principalId": "[parameters('stagingSlotPrincipalId')]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "roleAssignmentsCreated": {
              "type": "object",
              "value": {
                "production": {
                  "blob": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', split(parameters('storageAccountId'), '/')[8]), 'Microsoft.Authorization/roleAssignments', guid(parameters('storageAccountId'), parameters('functionAppPrincipalId'), variables('roles').storageBlobDataContributor))]",
                  "queue": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', split(parameters('storageAccountId'), '/')[8]), 'Microsoft.Authorization/roleAssignments', guid(parameters('storageAccountId'), parameters('functionAppPrincipalId'), variables('roles').storageQueueDataContributor))]",
                  "table": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', split(parameters('storageAccountId'), '/')[8]), 'Microsoft.Authorization/roleAssignments', guid(parameters('storageAccountId'), parameters('functionAppPrincipalId'), variables('roles').storageTableDataContributor))]",
                  "keyVault": "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', split(parameters('keyVaultId'), '/')[8]), 'Microsoft.Authorization/roleAssignments', guid(parameters('keyVaultId'), parameters('functionAppPrincipalId'), variables('roles').keyVaultSecretsUser))]"
                },
                "staging": {
                  "blob": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', split(parameters('storageAccountId'), '/')[8]), 'Microsoft.Authorization/roleAssignments', guid(parameters('storageAccountId'), parameters('stagingSlotPrincipalId'), variables('roles').storageBlobDataContributor))]",
                  "queue": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', split(parameters('storageAccountId'), '/')[8]), 'Microsoft.Authorization/roleAssignments', guid(parameters('storageAccountId'), parameters('stagingSlotPrincipalId'), variables('roles').storageQueueDataContributor))]",
                  "table": "[extensionResourceId(resourceId('Microsoft.Storage/storageAccounts', split(parameters('storageAccountId'), '/')[8]), 'Microsoft.Authorization/roleAssignments', guid(parameters('storageAccountId'), parameters('stagingSlotPrincipalId'), variables('roles').storageTableDataContributor))]",
                  "keyVault": "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', split(parameters('keyVaultId'), '/')[8]), 'Microsoft.Authorization/roleAssignments', guid(parameters('keyVaultId'), parameters('stagingSlotPrincipalId'), variables('roles').keyVaultSecretsUser))]"
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "functionApp",
        "keyVault",
        "storage"
      ]
    }
  },
  "outputs": {
    "functionAppName": {
      "type": "string",
      "value": "[reference('functionApp').outputs.functionAppName.value]"
    },
    "functionAppUrl": {
      "type": "string",
      "value": "[reference('functionApp').outputs.functionAppUrl.value]"
    },
    "functionAppPrincipalId": {
      "type": "string",
      "value": "[reference('functionApp').outputs.functionAppPrincipalId.value]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[reference('storage').outputs.storageAccountName.value]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[reference('keyVault').outputs.keyVaultName.value]"
    },
    "keyVaultUri": {
      "type": "string",
      "value": "[reference('keyVault').outputs.keyVaultUri.value]"
    },
    "appInsightsInstrumentationKey": {
      "type": "string",
      "value": "[reference('monitoring').outputs.instrumentationKey.value]"
    },
    "rbacRoleAssignments": {
      "type": "object",
      "value": "[reference('rbac').outputs.roleAssignmentsCreated.value]"
    }
  }
}