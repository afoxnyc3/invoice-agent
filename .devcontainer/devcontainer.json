{
    "name": "Invoice Agent Development",
    "dockerComposeFile": "../docker-compose.yml",
    "workspaceFolder": "/workspace",

    // Use Python 3.11 image with development tools
    "image": "mcr.microsoft.com/devcontainers/python:3.11",

    "features": {
        "ghcr.io/devcontainers/features/docker-in-docker:2": {},
        "ghcr.io/devcontainers/features/azure-cli:1": {},
        "ghcr.io/devcontainers/features/git:1": {},
        "ghcr.io/devcontainers/features/github-cli:1": {}
    },

    // Configure ports for local development
    "forwardPorts": [
        7071,  // Azure Functions
        10000, // Azurite Blob
        10001, // Azurite Queue
        10002, // Azurite Table
        8025   // MailHog UI (if enabled)
    ],

    "portsAttributes": {
        "7071": {
            "label": "Azure Functions",
            "onAutoForward": "notify"
        },
        "10000": {
            "label": "Azurite Blob"
        },
        "10001": {
            "label": "Azurite Queue"
        },
        "10002": {
            "label": "Azurite Table"
        },
        "8025": {
            "label": "MailHog UI"
        }
    },

    // VS Code extensions to install
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-python.python",
                "ms-python.vscode-pylance",
                "ms-python.black-formatter",
                "ms-azuretools.vscode-azurefunctions",
                "ms-azuretools.vscode-azurestorage",
                "ms-vscode.azure-account",
                "charliermarsh.ruff",
                "tamasfe.even-better-toml",
                "redhat.vscode-yaml",
                "eamodio.gitlens",
                "GitHub.copilot",
                "GitHub.vscode-pull-request-github"
            ],
            "settings": {
                "python.defaultInterpreterPath": "/workspace/src/venv/bin/python",
                "python.terminal.activateEnvironment": true,
                "python.testing.pytestEnabled": true,
                "python.linting.flake8Enabled": true,
                "python.formatting.provider": "black",
                "editor.formatOnSave": true,
                "editor.codeActionsOnSave": {
                    "source.organizeImports": "explicit"
                },
                "files.exclude": {
                    "**/__pycache__": true,
                    "**/*.pyc": true
                }
            }
        }
    },

    // Environment variables
    "containerEnv": {
        "PYTHONPATH": "/workspace/src",
        "ENVIRONMENT": "devcontainer",
        "AZURE_STORAGE_CONNECTION_STRING": "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://127.0.0.1:10000/devstoreaccount1;QueueEndpoint=http://127.0.0.1:10001/devstoreaccount1;TableEndpoint=http://127.0.0.1:10002/devstoreaccount1;"
    },

    // Mount the workspace and set up volumes
    "mounts": [
        "source=${localWorkspaceFolder},target=/workspace,type=bind,consistency=cached"
    ],

    // Run commands after container is created
    "postCreateCommand": "bash /workspace/scripts/setup-local.sh",

    // Keep container running
    "overrideCommand": true,

    // Use 'forwardPorts' to make a list of ports inside the container available locally.
    "remoteUser": "vscode"
}
